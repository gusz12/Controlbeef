<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title">ControlBeef | Frigorifico</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="/css/assets/iconControlBeef.ico">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/frigorifico.css">
</head>

<body onload="totalSalasFrigo(), listarSalas()">
    <div class="navbar">
        <div class="logo">
            <span>ControlBeef</span>
            <img src="/css/assets/logoControlBeef1.png" alt="logo ControlBeef">
        </div>
        <div class="menu">
            <div class="agora">
                <a href="dashboard.html">Dashboard</a>
            </div>
            <span>|</span>
            <a href="../cadastro.html">Cadastro de usuário</a>
            <span>|</span>
            <a onclick="sessionClear()" href="../index.html">Sair</a>
        </div>
        <div class="usuario">
            <span style="font-size: 50px;" id="nome_lateral"></span>
        </div>
    </div>

    <br><br><br>
    <div class="main-content" id="containerPrincipal">
        <div class="mensagemInicial">
            <h1>Frigorifico: <span id="nomeFrigorifico"></span></h1>
        </div>

        <div class="informacoes">
            <div class="KPIS">
                <div class="kpi">
                    Total de Salas: <h1 id="totalSalas">0</h1>
                </div>
                <div class="kpi">
                    Salas dentro do ideal: <h1 id="totalSalasIdeal">0</h1>
                </div>
                <div class="kpi">
                    Salas fora do ideal: <h1 id="totalSalasNaoIdeal">0</h1>
                </div>
            </div>
            <div class="SalasKPI" id="containerSalasTotal">
                


            </div>
        </div>
    </div>
    <div class="containerSalas" id="containerSala">


</body>

</html>
<script src="/js/dados.js"></script>
<script>
    nomeFrigorifico.innerHTML = sessionStorage.NOME_FRIGO_ATUAL
    nome_lateral.innerHTML = `${sessionStorage.NOME_USUARIO}`
    title.innerHTML = `
            ControlBeef | ${sessionStorage.NOME_FRIGO_ATUAL}
    `

    var idEmpresa = sessionStorage.ID_EMPRESA;
    var idFrigo = sessionStorage.FRIGO_ATUAL;

        let idSala = 0;

   function sala(id) {
    idSala = id; // define a sala atual
    containerPrincipal.style.display = "none";
    containerSala.style.display = "";

    fetch(`/frigorifico/dadosSala/${idSala}`)
        .then(res => res.json())
        .then(json => {
            let sala = json[0];

            // Atualiza o título da aba
            title.innerHTML = `ControlBeef | ${sala.nomeSala}`;

            // Atualiza o container da sala com o gráfico
            containerSala.innerHTML = `
                <div>
                    <button onclick="voltarFrigos()">Voltar</button>
                    <p>Sala: ${sala.nomeSala}</p>
                    <canvas id="graficoSala${sala.id}" width="400" height="200"></canvas>
                    <p>Última atualização: <span id="ultimaAtualizacao"></span></p>
                </div>
                <div>
                    <div class="KPIS">
                        <div class="kpi">Temperatura atual:</div>
                        <div class="kpi">Tempo fora do ideal:</div>
                    </div>
                    <div class="containerRegistro" id="containerRegistros">
                        <div class="Cabecalho">Dados Sala:</div>
                        <div class="corpo">
                            <div class="linha">
                                <div class="data item">Data/Hora</div> 
                                <div class="temperatura item">Temperatura</div>
                                <div class="ocorrencia item">Ocorrência</div>
                                <div class="sensor item">Sensor</div> 
                                <div class="status item">Status</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Buscar dados da sala e plota o gráfico inicial
            buscarDadosSala(idSala).then(dados => {
                plotarGraficoSala(idSala, dados);
                atualizarGraficoSala(idSala); // inicia atualização a cada 2 segundos
            });
        })
        .catch(erro => console.error('Erro ao carregar dados da sala:', erro));
}
 

    function voltarFrigos(){
        if(containerSala.style.display != "none"){
            containerSala.style.display = "none"
            containerPrincipal.style.display = ""
        } else {
            containerSala.style.display = ""
            containerPrincipal.style.display = "none"
        }
    }

    function atualizarGrafico(){
        fetch(`/frigorifico/criarGrafico/:idSala`,{
            method: "GET"
        }).then(res=>{
            res.json().then(json => {
                let dados = json[0];
                
            })
        })
    }

    function criarGráficoSala(id) {
       let idSala = id;
        let dadosInteresse = {
            labels: ['14:00', '13:00', '12:00'],
            datasets: [{
                label: 'Temperatura',
                data: [2, 3, 3],
                borderColor: '#5DD7ED',
                backgroundColor: '#5DD7ED',

                tension: 0.1,
                borderWidth: 2
            }],
            options: {
                animation: {
                    duration: 1500,
                    easing: 'easeOutBounce'
                },
                plugins: {
                    id: 'custom-icons',
                    afterDatasetsDraw(chart, args, pluginOptions) {

                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        }
        const configInteresse = {
            type: 'line',
            data: dadosInteresse,
        };
        let Interesses = new Chart(
            document.getElementById(`graficoSala${idSala}`),
            configInteresse
        );
    }



    function totalSalasFrigo() {

        var idEmpresa = sessionStorage.ID_EMPRESA;
        var idFrigo = sessionStorage.FRIGO_ATUAL;

        fetch(`/frigorifico/totalSalasFrigo/${idEmpresa}/${idFrigo}`, {
            method: "GET"
        })
            .then(res => {
                res.json().then(json => {
                    totalSalas.innerHTML = `<h1 style="margin:0px; font-size: 60px">${json[0].totalSalas}</h1>`
                })
            });
        totalSalasIdealFrigo();
    }




    function totalSalasIdealFrigo() {

        var idEmpresa = sessionStorage.ID_EMPRESA;
        var idFrigo = sessionStorage.FRIGO_ATUAL;

        fetch(`/frigorifico/totalSalasIdealFrigo/${idEmpresa}/${idFrigo}`, {
            method: "GET"
        })
            .then(res => {
                res.json().then(json => {
                    totalSalasIdeal.innerHTML = `<h1 style="margin:0px; font-size: 60px">${json[0].salasIdealFrigo}</h1>`
                })
            });
        totalSalasNIdealFrigo();
    }



    function totalSalasNIdealFrigo() {

        var idEmpresa = sessionStorage.ID_EMPRESA;
        var idFrigo = sessionStorage.FRIGO_ATUAL;

        fetch(`/frigorifico/totalSalasNIdealFrigo/${idEmpresa}/${idFrigo}`, {
            method: "GET"
        })
            .then(res => {
                res.json().then(json => {
                    salas = json[0]
                    console.log(salas.salasNIdealFrigo)
                    totalSalasNaoIdeal.innerHTML = `<h1 style="margin:0px; font-size: 60px">${salas.salasNIdealFrigo}</h1>`
                })
            });
    }
let globalJson;

    function listarSalas(){
        var idEmpresa = sessionStorage.ID_EMPRESA;
        var idFrigo = sessionStorage.FRIGO_ATUAL;
        fetch(`/frigorifico/listarSalas/${idEmpresa}/${idFrigo}`,{
            method: "GET"
        }).then(res => {
            res.json().then(json =>{
                globalJson = json;
                for(let c = 0; json.length > c; c++){
                    frigorificos = json[c]
                    console.log(frigorificos.id)
                    containerSalasTotal.innerHTML += 
                    `
                    <a onclick="sala(${frigorificos.id})" class="aComHover">
                    <div class="cardSala">
                        <div class="alinhar">
                            <p>Temperatura:${frigorificos.temperatura_media_sala}ºC</p>
                            <div class="bolinha" id="bolinha${c}"></div>
                        </div>
                        <p>Sala: ${frigorificos.nomeSala}</p>
                    </div>
                </a>
                    `
                }
        funcaoBolinhas()

            })
        })
    }
  function funcaoBolinhas() {
        for (c = 0; c < globalJson.length; c++) {
            let frigorificos = globalJson[c];

            let bolinhas = document.getElementById(`bolinha${c}`);

            console.log(`Posição ${c} com o Frigorico de status ${frigorificos.status_alerta}`)
            if(bolinhas != null){
                console.log("Entrou no if")
                if (frigorificos.status_alerta == 'Alerta') {
                bolinhas.style.backgroundColor = "#ffff00";
                console.log(bolinhas.style.backgroundColor)
            } else if (frigorificos.status_alerta == "Crítico") {
                bolinhas.style.backgroundColor = "#ff0000";
                console.log(bolinhas.style.backgroundColor)
            }else if(frigorificos.status_alerta == "Ideal"){
                bolinhas.style.backgroundColor = "#008000";
            } else {
                bolinhas.style.backgroundColor = "grey"
                console.log(bolinhas.style.backgroundColor)
            }
            }
            
        }
    }

    function buscarDadosSala(idSala) {
    return fetch(`/frigorifico/criarGrafico/${idSala}`)
        .then(res => res.json())
        .then(json => {
            console.log("Dados recebidos do backend:", json);
            return json;
        });
    }

    var graficoSala = null; // Variável global para atualizar depois

function plotarGraficoSala(idSala, dados) {
    const ctx = document.getElementById(`graficoSala${idSala}`).getContext('2d');

    if (graficoSala) {
        graficoSala.destroy();
    }

    const labels = dados.map(item => item.data);
    const temperaturas = dados.map(item => item.temperatura);

    graficoSala = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.reverse(),
            datasets: [{
                label: 'Temperatura (°C)',
                data: temperaturas.reverse(),
                borderColor: '#5DD7ED',
                backgroundColor: '#5DD7ED',
                tension: 0.1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
}


function atualizarGraficoSala(idSala) {
    setInterval(() => {
        buscarDadosSala(idSala)
            .then(dados => {
                plotarGraficoSala(idSala, dados);
            })
            .catch(erro => console.error('Erro ao atualizar gráfico:', erro));
    }, 2000);
}


    function sessionClear() {
        sessionStorage.clear();
    }

</script>